<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>逸潇次元拍—儿童未来职业照</title>
    <!-- 引入外部CSS样式文件 -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h2>儿童未来职业照-女孩篇</h2>

        <!-- 积分&邀请码区域 -->
        <div class="points-container">
            <div class="points-info">当前积分：<span id="currentPoints">0</span>（生成一次消耗1积分）</div>
            <div class="invite-code-box">
                <input type="text" id="inviteCodeInput" placeholder="输入令牌兑换积分">
                <button id="exchangeBtn" onclick="exchangeInviteCode()">兑换积分</button>
            </div>
        </div>

        <!-- Tag容器 -->
        <div class="tag-container">
            <h4>生成标签（共9个，可编辑，自动保存）：</h4>
            <div class="tag-list" id="tagList">
                <textarea class="tag-input" placeholder="输入标签1..."></textarea>
                <textarea class="tag-input" placeholder="输入标签2..."></textarea>
                <textarea class="tag-input" placeholder="输入标签3..."></textarea>
                <textarea class="tag-input" placeholder="输入标签4..."></textarea>
                <textarea class="tag-input" placeholder="输入标签5..."></textarea>
                <textarea class="tag-input" placeholder="输入标签6..."></textarea>
                <textarea class="tag-input" placeholder="输入标签7..."></textarea>
                <textarea class="tag-input" placeholder="输入标签8..."></textarea>
                <textarea class="tag-input" placeholder="输入标签9..."></textarea>
            </div>
        </div>
        
        <!-- 图片上传区域 -->
        <div class="upload-area" id="uploadArea">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择本地图片</button>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/jpg" />
            <div class="upload-tip">支持格式：jpg/png | 建议大小：≤10MB</div>
            <img id="previewImg" class="preview-img" alt="图片预览" />
        </div>
        
        <!-- 按钮组 -->
        <div class="btn-group">
            <button id="genGridBtn" onclick="startGridGeneration()" disabled>生成未来职业照</button>
            <button id="pauseBtn" onclick="togglePause()">暂停生成</button>
            <button id="retryFailedBtn" onclick="retryFailedImages()">重试失败图片</button>
            <button id="genSingleBtn" onclick="generateSingleImage()"></button>
        </div>
        
        <!-- 提示信息 -->
        <div id="loading">准备生成...</div>
        <div class="progress-tip" id="progressTip">长按图片即可保存</div>
        <div class="debug-log" id="debugLog">调试日志：</div>
        
        <!-- 九宫格展示 -->
        <div class="grid-container" id="gridContainer"></div>

        <!-- 历史记录区域 -->
        <div class="history-section">
            <div class="history-title">
                <span>生成历史记录</span>
                <div class="history-controls">
                    <button id="showHistoryBtn" class="history-btn" onclick="toggleHistoryList()">查看历史</button>
                    <button id="clearHistoryBtn" class="history-btn clear" onclick="clearAllHistory()" disabled>清空历史</button>
                </div>
            </div>
            <div id="historyList" class="history-list" style="display: block;">
                <div class="history-empty" id="historyEmpty">暂无生成记录</div>
            </div>
        </div>
    </div>

    <!-- 页面关闭提醒 -->
    <div class="beforeunload-tip" id="beforeunloadTip">⚠️ 图片生成中，关闭页面会导致生成中断！</div>

    <!-- 大图预览弹窗 -->
    <div class="img-preview-modal" id="imgPreviewModal">
        <div class="img-preview-content">
            <button class="close-preview-btn" onclick="closeImagePreview()">&times;</button>
            <img src="" alt="大图预览" class="preview-large-img" id="previewLargeImg">
        </div>
    </div>

    <!-- 引入外部API逻辑文件（放在body末尾确保DOM加载完成） -->
    <script src="api.js"></script>

    <!-- 新增：页面初始化脚本 -->
    <script>
        // 页面加载完成后执行初始化，重置当前生成状态（保留历史记录）
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 清空当前生成的九宫格（不影响历史记录）
            document.getElementById('gridContainer').innerHTML = '';

            // 2. 重置按钮状态
            const genGridBtn = document.getElementById('genGridBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            genGridBtn.disabled = true;
            pauseBtn.textContent = '暂停生成';

            // 3. 重置提示信息
            document.getElementById('loading').textContent = '准备生成...';
            document.getElementById('progressTip').textContent = '长按图片即可保存';
            document.getElementById('debugLog').textContent = '调试日志：';

            // 4. 清空预览图和文件输入
            const previewImg = document.getElementById('previewImg');
            previewImg.src = '';
            previewImg.style.display = 'none';
            document.getElementById('fileInput').value = '';

            // 5. 重置全局生成状态（适配api.js中的变量）
            if (typeof isGenerating !== 'undefined') isGenerating = false;
            if (typeof isPaused !== 'undefined') isPaused = false;
            if (typeof currentGridIndex !== 'undefined') currentGridIndex = 0;
            if (typeof failedImages !== 'undefined') failedImages = [];

            // 6. 隐藏页面关闭提醒、关闭大图预览弹窗
            document.getElementById('beforeunloadTip').style.display = 'none';
            closeImagePreview();

            // 7. 确保历史记录区域显示正常（仅优化显示，不修改数据）
            const historyList = document.getElementById('historyList');
            if (historyList.children.length === 1 && historyList.querySelector('.history-empty')) {
                document.getElementById('historyEmpty').style.display = 'block';
            } else {
                document.getElementById('historyEmpty').style.display = 'none';
            }
        });

        // 确保closeImagePreview函数存在（兼容api.js未定义的情况）
        if (typeof closeImagePreview === 'undefined') {
            function closeImagePreview() {
                const modal = document.getElementById('imgPreviewModal');
                modal.style.display = 'none';
                document.getElementById('previewLargeImg').src = '';
            }
        }
    </script>
</body>
</html>