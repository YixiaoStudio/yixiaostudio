<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>seeDream4.5 上传图片生成写真照</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 20px;
            width: 100%; /* 适配小屏幕 */
        }
        h2 {
            color: #333;
            margin: 20px 0;
            text-align: center;
        }
        /* 模式切换按钮 */
        .mode-group {
            margin: 10px 0;
        }
        .mode-btn {
            padding: 8px 16px;
            margin-right: 8px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .mode-btn.active {
            background: #165DFF;
            color: white;
            border-color: #165DFF;
        }
        /* 文件上传区域 */
        .upload-area {
            margin: 10px 0;
            padding: 20px;
            border: 1px dashed #eee;
            border-radius: 4px;
            display: none;
        }
        .upload-btn {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        #fileInput {
            display: none;
        }
        .upload-tip {
            font-size: 12px;
            color: #999;
            margin: 5px 0;
        }
        .preview-img {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
            border: 1px solid #eee;
        }
        /* 生成按钮 */
        #genBtn {
            padding: 10px 20px;
            background: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        #genBtn:disabled {
            background: #88b1ff;
            cursor: not-allowed;
        }
        /* 加载提示 */
        #loading {
            display: none;
            color: #666;
            margin: 20px 0;
            font-size: 16px;
            text-align: center;
        }
        /* 单张图片容器（3:4比例，适配屏幕） */
        .single-image-container {
            margin-top: 20px;
            width: 100%;
            max-width: 600px; /* 限制最大宽度，避免大屏拉伸 */
            margin-left: auto;
            margin-right: auto; /* 居中显示 */
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            /* 核心：3:4比例（padding-top = 高度/宽度 * 100% = 4/3 * 100% ≈ 133.33%） */
            padding-top: 133.33%; 
            background: #f9f9f9;
            border: 1px solid #eee;
        }
        /* 单张图片样式 */
        .single-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* 保持图片完整，不裁剪 */
            transition: transform 0.2s ease;
        }
        .single-img:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .single-img.error {
            border-color: #ff4d4f;
            color: #ff4d4f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        /* 结果提示 */
        .result-tip {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>seeDream4.5 上传图片生成写真照</h2>
        
        <!-- 模式切换：仅保留图生图 -->
        <div class="mode-group">
            <button class="mode-btn active" onclick="switchMode('img2img')">图生图</button>
        </div>
        
        <!-- 移除提示词输入框 -->
        
        <!-- 图生图专属：文件上传区域 -->
        <div class="upload-area" id="uploadArea">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择本地图片</button>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/jpg" />
            <div class="upload-tip">支持格式：jpg/png | 建议大小：≤10MB</div>
            <!-- 图片预览 -->
            <img id="previewImg" class="preview-img" alt="图片预览" />
        </div>
        
        <!-- 生成按钮 -->
        <button id="genBtn" onclick="generateSingleImage()">生成写真照</button>
        
        <!-- 加载提示 -->
        <div id="loading">准备生成...</div>
        
        <!-- 单张图片展示容器 -->
        <div class="single-image-container" id="resultImageContainer"></div>
        
        <!-- 结果提示 -->
        <div class="result-tip" id="resultTip"></div>
    </div>

    <script>
        // 全局变量：当前模式、上传后的图片URL
        let currentMode = 'img2img';
        let uploadedImageUrl = '';
        // 后端接口地址（替换为你的火山引擎API网关公网地址）
        const VOLC_API_BASE = 'https://sd5j17d5mg7k3v1e7vu60.apigateway-cn-beijing.volceapi.com'; 
        const UPLOAD_API = VOLC_API_BASE + '/api/upload-to-tos';
        const GENERATE_API = VOLC_API_BASE + '/api/generate-image';

        // 1. 切换模式（仅保留图生图逻辑）
        function switchMode(mode) {
            currentMode = mode;
            // 更新按钮样式
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick.toString().includes(mode)) {
                    btn.classList.add('active');
                }
            });
            // 显示文件上传区域（固定显示）
            document.getElementById('uploadArea').style.display = 'block';
            // 重置状态
            uploadedImageUrl = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('resultImageContainer').innerHTML = '';
            document.getElementById('resultTip').textContent = '';
        }

        // 2. 监听文件选择事件（预览+上传）
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 第一步：显示图片预览
            const previewImg = document.getElementById('previewImg');
            previewImg.src = URL.createObjectURL(file);
            previewImg.style.display = 'block';

            // 第二步：将文件转为Base64
            const base64Str = await fileToBase64(file);
            
            // 第三步：上传到后端TOS接口，获取公网URL
            uploadImageToTOS(base64Str);
        });

        // 辅助函数：文件转Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }

        // 3. 上传Base64图片到后端TOS接口
        async function uploadImageToTOS(base64Str) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = '正在上传图片到服务器...';

            try {
                const res = await fetch(UPLOAD_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base64Str: base64Str })
                });
                const data = await res.json();

                if (data.code === 0) {
                    // 上传成功，保存公网URL
                    uploadedImageUrl = data.data.imageUrl;
                    loading.textContent = '图片上传成功！准备生成写真...';
                } else {
                    alert('图片上传失败：' + data.message);
                    uploadedImageUrl = '';
                    loading.textContent = '图片上传失败';
                }
            } catch (err) {
                alert('上传异常：' + err.message);
                uploadedImageUrl = '';
                loading.textContent = '上传异常';
            }
        }

        // 4. 单次调用生成图片接口（移除prompt参数）
        async function callGenerateApi(imageUrl) {
            try {
                const res = await fetch(GENERATE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // 不再传prompt，后端使用默认值
                        imageUrl: imageUrl
                    })
                });
                const data = await res.json();
                if (data.code !== 0) {
                    throw new Error(data.message || '生成图片失败');
                }
                return data.data; // 返回图片URL数组
            } catch (err) {
                throw err;
            }
        }

        // 5. 渲染单张图片
        function renderSingleImage(url) {
            const container = document.getElementById('resultImageContainer');
            container.innerHTML = ''; // 清空原有内容
            const img = document.createElement('img');
            img.className = 'single-img';
            img.src = url;
            img.alt = '生成的写真照';
            // 图片加载失败兜底
            img.onerror = function() {
                this.classList.add('error');
                this.src = '';
                this.alt = '图片加载失败';
                this.textContent = '图片加载失败';
            };
            container.appendChild(img);
        }

        // 6. 核心：生成单张图片（移除prompt校验）
        async function generateSingleImage() {
            // 仅校验图片是否上传
            if (currentMode === 'img2img' && !uploadedImageUrl) {
                alert('请先选择并上传本地图片！');
                return;
            }

            // 初始化状态
            const genBtn = document.getElementById('genBtn');
            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultImageContainer');
            const resultTip = document.getElementById('resultTip');

            genBtn.disabled = true;
            loading.style.display = 'block';
            resultContainer.innerHTML = '';
            resultTip.textContent = '';

            try {
                // 生成图片
                loading.textContent = '正在生成写真照...';
                const imageData = await callGenerateApi(uploadedImageUrl);
                // 取第一张图渲染
                renderSingleImage(imageData[0].url);

                // 生成完成
                loading.style.display = 'none';
                resultTip.textContent = '✅ 写真照生成成功！（3:4比例适配屏幕）';

            } catch (err) {
                // 错误处理
                loading.style.display = 'none';
                resultTip.textContent = `❌ 生成失败：${err.message}`;
                alert(`生成失败：${err.message}`);
            } finally {
                // 恢复按钮状态
                genBtn.disabled = false;
            }
        }

        // 初始化：默认显示图生图区域
        switchMode('img2img');
    </script>
</body>
</html>