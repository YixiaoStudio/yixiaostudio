<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>seeDream4.5 上传图片生成写真照</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .container {
            max-width: 960px;
            margin: 20px auto;
            padding: 0 20px;
            width: 100%; /* 适配小屏幕 */
        }
        h2 {
            color: #333;
            margin: 20px 0;
            text-align: center;
        }
        /* 模式切换按钮 */
        .mode-group {
            margin: 10px 0;
        }
        .mode-btn {
            padding: 8px 16px;
            margin-right: 8px;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .mode-btn.active {
            background: #165DFF;
            color: white;
            border-color: #165DFF;
        }
        /* 文件上传区域 */
        .upload-area {
            margin: 10px 0;
            padding: 20px;
            border: 1px dashed #eee;
            border-radius: 4px;
            display: none;
        }
        .upload-btn {
            padding: 10px 20px;
            background: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        #fileInput {
            display: none;
        }
        .upload-tip {
            font-size: 12px;
            color: #999;
            margin: 5px 0;
        }
        .preview-img {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
            border: 1px solid #eee;
        }
        /* 生成按钮 */
        #genBtn {
            padding: 10px 20px;
            background: #165DFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        #genBtn:disabled {
            background: #88b1ff;
            cursor: not-allowed;
        }
        /* 加载提示 + 进度条容器 */
        #loading {
            display: none;
            color: #666;
            margin: 20px 0;
            font-size: 16px;
            text-align: center;
        }
        /* 进度条样式 */
        .progress-container {
            width: 100%;
            max-width: 600px;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin: 10px auto;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #165DFF;
            border-radius: 4px;
            transition: width 0.3s ease; /* 平滑过渡 */
        }
        /* 单张图片容器（3:4比例） */
        .single-image-container {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            padding-top: 133.33%; 
            background: #f9f9f9;
            border: 1px solid #eee;
        }
        /* 单张图片样式 */
        .single-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease;
        }
        .single-img:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .single-img.error {
            border-color: #ff4d4f;
            color: #ff4d4f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        /* 结果提示 */
        .result-tip {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>seeDream4.5 上传图片生成写真照</h2>
        
        <!-- 模式切换：仅保留图生图 -->
        <div class="mode-group">
            <button class="mode-btn active" onclick="switchMode('img2img')">图生图</button>
        </div>
        
        <!-- 图生图专属：文件上传区域 -->
        <div class="upload-area" id="uploadArea">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择本地图片</button>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/jpg" />
            <div class="upload-tip">支持格式：jpg/png | 建议大小：≤10MB</div>
            <img id="previewImg" class="preview-img" alt="图片预览" />
        </div>
        
        <!-- 生成按钮 -->
        <button id="genBtn" onclick="generateSingleImage()">生成写真照</button>
        
        <!-- 加载提示 + 进度条 -->
        <div id="loading">准备生成...</div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <!-- 单张图片展示容器 -->
        <div class="single-image-container" id="resultImageContainer"></div>
        
        <!-- 结果提示 -->
        <div class="result-tip" id="resultTip"></div>
    </div>

    <script>
        // 全局变量
        let currentMode = 'img2img';
        let uploadedImageUrl = '';
        let progressInterval = null; // 进度条定时器
        // 后端接口地址
        const VOLC_API_BASE = 'https://sd5j17d5mg7k3v1e7vu60.apigateway-cn-beijing.volceapi.com'; 
        const UPLOAD_API = VOLC_API_BASE + '/api/upload-to-tos';
        const GENERATE_API = VOLC_API_BASE + '/api/generate-image';

        // 1. 切换模式
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick.toString().includes(mode)) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('uploadArea').style.display = 'block';
            // 重置状态（包括进度条）
            resetProgress();
            uploadedImageUrl = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('resultImageContainer').innerHTML = '';
            document.getElementById('resultTip').textContent = '';
        }

        // 2. 监听文件选择
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 预览图片
            const previewImg = document.getElementById('previewImg');
            previewImg.src = URL.createObjectURL(file);
            previewImg.style.display = 'block';

            // 转Base64并上传
            const base64Str = await fileToBase64(file);
            uploadImageToTOS(base64Str);
        });

        // 辅助：文件转Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }

        // 3. 上传图片到TOS
        async function uploadImageToTOS(base64Str) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.textContent = '正在上传图片到服务器...';
            
            // 上传阶段也显示进度条（0-50%）
            startProgress(0, 50, '上传中...');

            try {
                const res = await fetch(UPLOAD_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base64Str: base64Str })
                });
                const data = await res.json();

                if (data.code === 0) {
                    uploadedImageUrl = data.data.imageUrl;
                    loading.textContent = '图片上传成功！准备生成写真...';
                    updateProgress(50); // 上传完成，进度到50%
                } else {
                    alert('图片上传失败：' + data.message);
                    uploadedImageUrl = '';
                    loading.textContent = '图片上传失败';
                    resetProgress();
                }
            } catch (err) {
                alert('上传异常：' + err.message);
                uploadedImageUrl = '';
                loading.textContent = '上传异常';
                resetProgress();
            }
        }

        // 4. 调用生成接口
        async function callGenerateApi(imageUrl) {
            return new Promise(async (resolve, reject) => {
                try {
                    // 生成阶段进度条（50-90%）
                    startProgress(50, 90, '生成写真中...');

                    const res = await fetch(GENERATE_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageUrl: imageUrl })
                    });
                    const data = await res.json();

                    if (data.code !== 0) {
                        throw new Error(data.message || '生成图片失败');
                    }
                    // 生成完成，进度到100%
                    updateProgress(100);
                    resolve(data.data);
                } catch (err) {
                    reject(err);
                }
            });
        }

        // 5. 渲染图片
        function renderSingleImage(url) {
            const container = document.getElementById('resultImageContainer');
            container.innerHTML = '';
            const img = document.createElement('img');
            img.className = 'single-img';
            img.src = url;
            img.alt = '生成的写真照';
            img.onerror = function() {
                this.classList.add('error');
                this.src = '';
                this.alt = '图片加载失败';
                this.textContent = '图片加载失败';
            };
            container.appendChild(img);
        }

        // 6. 核心：生成图片（含进度条逻辑）
        async function generateSingleImage() {
            // 校验图片
            if (currentMode === 'img2img' && !uploadedImageUrl) {
                alert('请先选择并上传本地图片！');
                return;
            }

            // 初始化状态
            const genBtn = document.getElementById('genBtn');
            const loading = document.getElementById('loading');
            const resultContainer = document.getElementById('resultImageContainer');
            const resultTip = document.getElementById('resultTip');

            genBtn.disabled = true;
            loading.style.display = 'block';
            resultContainer.innerHTML = '';
            resultTip.textContent = '';

            try {
                // 调用生成接口
                const imageData = await callGenerateApi(uploadedImageUrl);
                // 渲染图片
                renderSingleImage(imageData[0].url);

                // 完成状态
                loading.style.display = 'none';
                hideProgress();
                resultTip.textContent = '✅ 写真照生成成功！（3:4比例适配屏幕）';

            } catch (err) {
                // 失败状态
                loading.style.display = 'none';
                resetProgress();
                resultTip.textContent = `❌ 生成失败：${err.message}`;
                alert(`生成失败：${err.message}`);
            } finally {
                genBtn.disabled = false;
            }
        }

        // ========== 进度条核心函数 ==========
        // 重置进度条
        function resetProgress() {
            clearInterval(progressInterval);
            progressInterval = null;
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            progressBar.style.width = '0%';
            progressContainer.style.display = 'none';
        }

        // 隐藏进度条
        function hideProgress() {
            clearInterval(progressInterval);
            progressInterval = null;
            document.getElementById('progressContainer').style.display = 'none';
        }

        // 更新进度条到指定百分比
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            percent = Math.min(100, Math.max(0, percent)); // 限制0-100
            progressBar.style.width = `${percent}%`;
            // 100%后自动隐藏
            if (percent === 100) {
                setTimeout(hideProgress, 500);
            }
        }

        // 启动进度条（从start到end，带提示文本）
        function startProgress(startPercent, endPercent, text) {
            // 清除原有定时器
            clearInterval(progressInterval);
            // 显示进度条容器
            const progressContainer = document.getElementById('progressContainer');
            const loading = document.getElementById('loading');
            progressContainer.style.display = 'block';
            loading.textContent = text;

            // 设置初始进度
            updateProgress(startPercent);
            let currentPercent = startPercent;
            // 计算每次增长的步长（总时长约等于生成耗时，这里设为15秒完成50-90%）
            const step = (endPercent - startPercent) / 150; // 15秒 = 150次 * 100ms

            // 启动定时器更新进度
            progressInterval = setInterval(() => {
                currentPercent += step;
                if (currentPercent >= endPercent) {
                    currentPercent = endPercent;
                    clearInterval(progressInterval);
                }
                updateProgress(currentPercent);
            }, 100);
        }

        // 初始化
        switchMode('img2img');
    </script>
</body>
</html>